@page "/settings"
@inject ThemeService ThemeService
@inject UserService UserService
@inject AuthenticationService AuthService
@inject ExportService ExportService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Settings - My Journal</PageTitle>

<AuthGuard>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>Settings</h3>
            <span class="text-muted">@UserService.CurrentUser?.FullName</span>
        </div>

        <!-- User Profile -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Profile Information</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Username:</strong> @UserService.CurrentUser?.Username
                    </div>
                    <div class="col-md-6">
                        <strong>Full Name:</strong> @UserService.CurrentUser?.FullName
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Email:</strong> @(UserService.CurrentUser?.Email ?? "Not set")
                    </div>
                    <div class="col-md-6">
                        <strong>Member Since:</strong> @UserService.CurrentUser?.CreatedAt.ToString("MMMM dd, yyyy")
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Current Streak:</strong>
                        <span class="badge bg-success">@UserService.CurrentUser?.CurrentStreak days</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Longest Streak:</strong>
                        <span class="badge bg-primary">@UserService.CurrentUser?.LongestStreak days</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Appearance Settings -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Appearance</h5>
            </div>
            <div class="card-body">
                <div class="form-check form-switch">
                    <input class="form-check-input"
                           type="checkbox"
                           id="darkModeSwitch"
                           checked="@isDarkMode"
                           @onchange="ToggleDarkMode">
                    <label class="form-check-label" for="darkModeSwitch">
                        <strong>Dark Mode</strong>
                        <br />
                        <small class="text-muted">Switch between light and dark themes</small>
                    </label>
                </div>
            </div>
        </div>

        <!-- Security Settings -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Security</h5>
            </div>
            <div class="card-body">
                <h6>PIN Protection</h6>
                <p class="text-muted">
                    @if (hasPinSet)
                    {
                        <span>PIN is currently <strong>enabled</strong> for quick login.</span>
                    }
                    else
                    {
                        <span>No PIN set. Set a PIN for quick login access.</span>
                    }
                </p>

                @if (!showPinForm)
                {
                    <button class="btn btn-primary" @onclick="ShowSetPinForm">
                        @(hasPinSet ? "Change PIN" : "Set PIN")
                    </button>

                    @if (hasPinSet)
                    {
                        <button class="btn btn-outline-danger ms-2" @onclick="RemovePin">
                            Remove PIN
                        </button>
                    }
                }
                else
                {
                    <div class="mt-3">
                        @if (hasPinSet)
                        {
                            <div class="mb-3">
                                <label class="form-label">Current PIN</label>
                                <input type="password"
                                       class="form-control"
                                       @bind="currentPin"
                                       maxlength="4"
                                       placeholder="Enter current PIN" />
                            </div>
                        }

                        <div class="mb-3">
                            <label class="form-label">New PIN (4 digits)</label>
                            <input type="password"
                                   class="form-control"
                                   @bind="newPin"
                                   maxlength="4"
                                   placeholder="Enter 4-digit PIN" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Confirm New PIN</label>
                            <input type="password"
                                   class="form-control"
                                   @bind="confirmPin"
                                   maxlength="4"
                                   placeholder="Re-enter PIN" />
                        </div>

                        @if (!string.IsNullOrEmpty(pinErrorMessage))
                        {
                            <div class="alert alert-danger">@pinErrorMessage</div>
                        }

                        <button class="btn btn-success" @onclick="SavePin">Save PIN</button>
                        <button class="btn btn-secondary ms-2" @onclick="CancelPinForm">Cancel</button>
                    </div>
                }
            </div>
        </div>

        <!-- Export Settings -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Export</h5>
            </div>
            <div class="card-body">
                <h6>Export Your Journal</h6>
                <p class="text-muted">Download your journal entries as HTML or text files.</p>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Start Date</label>
                        <input type="date" class="form-control" @bind="exportStartDate" />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">End Date</label>
                        <input type="date" class="form-control" @bind="exportEndDate" />
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(exportMessage))
                {
                    <div class="alert alert-info">@exportMessage</div>
                }

                <button class="btn btn-primary" @onclick="ExportToHtml" disabled="@isExporting">
                    @if (isExporting)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    Export to HTML
                </button>
                <button class="btn btn-outline-primary ms-2" @onclick="ExportToText" disabled="@isExporting">
                    Export to Text
                </button>
            </div>
        </div>

        <!-- Account Actions -->
        <div class="card mt-4 border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">Account Actions</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-danger" @onclick="Logout">
                    <span class="oi oi-account-logout me-2"></span>
                    Logout
                </button>
            </div>
        </div>
    </div>
</AuthGuard>

@code {
    private bool isDarkMode = false;
    private bool hasPinSet = false;
    private bool showPinForm = false;
    private string currentPin = "";
    private string newPin = "";
    private string confirmPin = "";
    private string? pinErrorMessage = null;

    private DateTime exportStartDate = DateTime.Today.AddMonths(-1);
    private DateTime exportEndDate = DateTime.Today;
    private bool isExporting = false;
    private string? exportMessage = null;

    protected override async Task OnInitializedAsync()
    {
        if (UserService.CurrentUser != null)
        {
            isDarkMode = UserService.CurrentUser.Theme == "Dark";
            hasPinSet = await AuthService.IsPinSetAsync();
        }
    }

    // private async Task ToggleDarkMode(ChangeEventArgs e)
    // {
    //     isDarkMode = (bool)e.Value!;
    //     await UserService.UpdateUserThemeAsync(isDarkMode ? "Dark" : "Light");
    // }
    private async Task ToggleDarkMode(ChangeEventArgs e)
    {
        isDarkMode = (bool)e.Value!;
        var newTheme = isDarkMode ? "Dark" : "Light";

        if (UserService.CurrentUser != null)
        {
            // Correct call: pass the theme string
            await UserService.UpdateUserThemeAsync(newTheme);
            await ThemeService.SetThemeAsync(newTheme);
        }
    }


    private void ShowSetPinForm()
    {
        showPinForm = true;
        pinErrorMessage = null;
        currentPin = "";
        newPin = "";
        confirmPin = "";
    }

    private void CancelPinForm()
    {
        showPinForm = false;
        pinErrorMessage = null;
    }

    private async Task SavePin()
    {
        pinErrorMessage = null;

        // Validate PIN
        if (string.IsNullOrWhiteSpace(newPin) || newPin.Length != 4)
        {
            pinErrorMessage = "PIN must be exactly 4 digits.";
            return;
        }

        if (!newPin.All(char.IsDigit))
        {
            pinErrorMessage = "PIN must contain only numbers.";
            return;
        }

        if (newPin != confirmPin)
        {
            pinErrorMessage = "PINs do not match.";
            return;
        }

        // If PIN exists, verify current PIN
        if (hasPinSet)
        {
            if (string.IsNullOrWhiteSpace(currentPin))
            {
                pinErrorMessage = "Please enter your current PIN.";
                return;
            }

            var result = await AuthService.ChangePinAsync(currentPin, newPin);
            if (!result)
            {
                pinErrorMessage = "Current PIN is incorrect.";
                return;
            }
        }
        else
        {
            // Set new PIN
            await AuthService.SetPinAsync(newPin);
        }

        hasPinSet = true;
        showPinForm = false;
        pinErrorMessage = null;
    }

    private async Task RemovePin()
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm",
            "Are you sure you want to remove PIN protection?");

        if (confirmed)
        {
            // Prompt for current PIN
            string? pin = await JS.InvokeAsync<string>("prompt", "Enter your current PIN:");

            if (!string.IsNullOrEmpty(pin))
            {
                var success = await AuthService.RemovePinAsync(pin);
                if (success)
                {
                    hasPinSet = false;
                }
                else
                {
                    await JS.InvokeVoidAsync("alert", "Incorrect PIN");
                }
            }
        }
    }

    private async Task ExportToHtml()
    {
        try
        {
            isExporting = true;
            exportMessage = null;

            var filePath = await ExportService.ExportToHtmlAsync(exportStartDate, exportEndDate);
            exportMessage = $"Successfully exported to: {Path.GetFileName(filePath)}";

            // Optionally share the file
            await ExportService.ShareFileAsync(filePath);
        }
        catch (Exception ex)
        {
            exportMessage = $"Export failed: {ex.Message}";
        }
        finally
        {
            isExporting = false;
        }
    }

    private async Task ExportToText()
    {
        try
        {
            isExporting = true;
            exportMessage = null;

            var filePath = await ExportService.ExportToTextAsync(exportStartDate, exportEndDate);
            exportMessage = $"Successfully exported to: {Path.GetFileName(filePath)}";

            // Optionally share the file
            await ExportService.ShareFileAsync(filePath);
        }
        catch (Exception ex)
        {
            exportMessage = $"Export failed: {ex.Message}";
        }
        finally
        {
            isExporting = false;
        }
    }

    private void Logout()
    {
        UserService.Logout();
        Navigation.NavigateTo("/login", forceLoad: true);
    }
}
