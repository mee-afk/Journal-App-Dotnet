@page "/settings"

@inject ThemeService ThemeService
@inject UserService UserService
@inject AuthenticationService AuthService
@inject ExportService ExportService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Settings - My Journal</PageTitle>
<style>
    accordion-content: padding  2.5rem;
</style>
<AuthGuard>
    <div class="settings-page">
        <div class="settings-header">
            <div>
                <h1>⚙️ Settings</h1>
                <p class="settings-subtitle">Manage your account and preferences</p>
            </div>
            <div class="user-badge">
                <div class="user-avatar">@GetInitials()</div>
                <div class="user-info">
                    <div class="user-name">@UserService.CurrentUser?.FullName</div>
                    <div class="user-email">@UserService.CurrentUser?.Email</div>
                </div>
            </div>
        </div>

        <div class="settings-container">
            <!-- Profile Section -->
            <div class="settings-accordion-item @(activeSection == "profile" ? "active" : "")">
                <div class="accordion-header" @onclick='() => ToggleSection("profile")'>
                    <div class="header-left">
                        <span class="accordion-icon">👤</span>
                        <span class="accordion-title">Profile Information</span>
                    </div>
                    <span class="accordion-arrow">@(activeSection == "profile" ? "▼" : "▶")</span>
                </div>
                @if (activeSection == "profile")
                {
                    <div class="accordion-content ">
                        <div class="profile-grid">
                            <div class="profile-item">
                                <label>Username</label>
                                <div class="profile-value">@UserService.CurrentUser?.Username</div>
                            </div>
                            <div class="profile-item">
                                <label>Full Name</label>
                                <div class="profile-value">@UserService.CurrentUser?.FullName</div>
                            </div>
                            <div class="profile-item">
                                <label>Email Address</label>
                                <div class="profile-value">@(UserService.CurrentUser?.Email ?? "Not set")</div>
                            </div>
                            <div class="profile-item">
                                <label>Member Since</label>
                                <div class="profile-value">@UserService.CurrentUser?.CreatedAt.ToString("MMMM dd, yyyy")</div>
                            </div>
                            <div class="profile-item">
                                <label>Current Streak</label>
                                <div class="profile-value">
                                    <span class="streak-badge success">🔥 @UserService.CurrentUser?.CurrentStreak days</span>
                                </div>
                            </div>
                            <div class="profile-item">
                                <label>Longest Streak</label>
                                <div class="profile-value">
                                    <span class="streak-badge primary">🏆 @UserService.CurrentUser?.LongestStreak days</span>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Appearance Section -->
            <div class="settings-accordion-item @(activeSection == "appearance" ? "active" : "")">
                <div class="accordion-header" @onclick='() => ToggleSection("appearance")'>
                    <div class="header-left">
                        <span class="accordion-icon">🎨</span>
                        <span class="accordion-title">Appearance</span>
                    </div>
                    <span class="accordion-arrow">@(activeSection == "appearance" ? "▼" : "▶")</span>
                </div>
                @if (activeSection == "appearance")
                {
                    <div class="accordion-content">
                        <div class="setting-option">
                            <div class="option-info">
                                <div class="option-title">Dark Mode</div>
                                <div class="option-description">Switch between light and dark themes</div>
                            </div>
                            <label class="theme-toggle">
                                <input type="checkbox"
                                       checked="@isDarkMode"
                                       @onchange="ToggleDarkMode">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div class="theme-preview">
                            <div class="preview-card @(isDarkMode ? "dark" : "light")">
                                <div class="preview-header">Preview</div>
                                <div class="preview-content">
                                    <div class="preview-text">Sample journal entry text</div>
                                    <div class="preview-buttons">
                                        <button class="preview-btn">Button</button>
                                        <button class="preview-btn-outline">Button</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Security Section -->
            <div class="settings-accordion-item @(activeSection == "security" ? "active" : "")">
                <div class="accordion-header" @onclick='() => ToggleSection("security")'>
                    <div class="header-left">
                        <span class="accordion-icon">🔒</span>
                        <span class="accordion-title">Security & Authentication</span>
                    </div>
                    <span class="accordion-arrow">@(activeSection == "security" ? "▼" : "▶")</span>
                </div>
                @if (activeSection == "security")
                {
                    <div class="accordion-content">
                        <!-- Change Password -->
                        <div class="security-section">
                            <h6 class="section-title">Change Password</h6>
                            <p class="section-description">Update your account password for security</p>

                            @if (!showPasswordForm)
                            {
                                <button class="btn-primary" @onclick="ShowPasswordForm">
                                    <span class="btn-icon">🔑</span> Change Password
                                </button>
                            }
                            else
                            {
                                <div class="form-container">
                                    <div class="form-group">
                                        <label>Current Password</label>
                                        <input type="password"
                                               class="form-input"
                                               @bind="currentPassword"
                                               placeholder="Enter current password" />
                                    </div>

                                    <div class="form-group">
                                        <label>New Password</label>
                                        <input type="password"
                                               class="form-input"
                                               @bind="newPassword"
                                               placeholder="Enter new password" />
                                        <small class="form-hint">Must be at least 6 characters</small>
                                    </div>

                                    <div class="form-group">
                                        <label>Confirm New Password</label>
                                        <input type="password"
                                               class="form-input"
                                               @bind="confirmPassword"
                                               placeholder="Re-enter new password" />
                                    </div>

                                    @if (!string.IsNullOrEmpty(passwordMessage))
                                    {
                                        <div class="alert @(passwordSuccess ? "alert-success" : "alert-error")">
                                            @passwordMessage
                                        </div>
                                    }

                                    <div class="form-actions">
                                        <button class="btn-success" @onclick="ChangePassword">
                                            Save Password
                                        </button>
                                        <button class="btn-secondary" @onclick="CancelPasswordForm">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>

                        <div class="divider"></div>

                        <!-- Quick PIN Login -->
                        <div class="security-section">
                            <h6 class="section-title">Quick PIN Login</h6>
                            <p class="section-description">Generate a unique 6-digit PIN for faster login access</p>

                            @if (!hasPinSet)
                            {
                                <div class="pin-info-box">
                                    <div class="info-icon">ℹ️</div>
                                    <div>
                                        <strong>No PIN Generated</strong>
                                        <p>Generate a unique PIN to enable quick login. The PIN will be auto-generated and cannot be customized.</p>
                                    </div>
                                </div>
                                <button class="btn-primary" @onclick="GeneratePin" disabled="@isGeneratingPin">
                                    @if (isGeneratingPin)
                                    {
                                        <span class="spinner"></span>
                                    }
                                    else
                                    {
                                        <span class="btn-icon">🎲</span>
                                    }
                                    Generate PIN
                                </button>
                            }
                            else
                            {
                                <div class="pin-display-box">
                                    <div class="pin-status">
                                        <span class="status-indicator active"></span>
                                        <span>PIN Active</span>
                                    </div>

                                    @if (showGeneratedPin)
                                    {
                                        <div class="pin-reveal">
                                            <div class="pin-label">Your PIN (Save this securely):</div>
                                            <div class="pin-code">@generatedPinCode</div>
                                            <button class="btn-copy" @onclick="CopyPinToClipboard">
                                                <span class="btn-icon">📋</span> Copy PIN
                                            </button>
                                            <div class="pin-warning">
                                                ⚠️ This PIN will only be shown once. Please save it securely.
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="pin-hidden">
                                            <div class="pin-label">PIN Code:</div>
                                            <div class="pin-masked">● ● ● ● ● ●</div>
                                            <small class="text-muted">PIN is hidden for security</small>
                                        </div>
                                    }
                                </div>

                                <div class="pin-actions">
                                    <button class="btn-info-outline" @onclick="ShowViewPinDialog">
                                        <span class="btn-icon">👁️</span> View PIN 🔒
                                    </button>
                                    <button class="btn-danger-outline" @onclick="ShowDeletePinDialog">
                                        <span class="btn-icon">🗑️</span> Delete PIN 🔒
                                    </button>
                                    <button class="btn-primary-outline" @onclick="ShowRegeneratePinDialog">
                                        <span class="btn-icon">🔄</span> Regenerate PIN 🔒
                                    </button>
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(pinMessage))
                            {
                                <div class="alert alert-info mt-3">@pinMessage</div>
                            }
                        </div>
                    </div>
                }
            </div>

            <!-- Export Section -->
            <div class="settings-accordion-item @(activeSection == "export" ? "active" : "")">
                <div class="accordion-header" @onclick='() => ToggleSection("export")'>
                    <div class="header-left">
                        <span class="accordion-icon">📥</span>
                        <span class="accordion-title">Export Journal</span>
                    </div>
                    <span class="accordion-arrow">@(activeSection == "export" ? "▼" : "▶")</span>
                </div>
                @if (activeSection == "export")
                {
                    <div class="accordion-content">
                        <p class="section-description">Download your journal entries as a beautifully formatted PDF document</p>

                        <div class="export-date-range">
                            <div class="form-group">
                                <label>Start Date</label>
                                <input type="date" class="form-input" @bind="exportStartDate" />
                            </div>
                            <div class="form-group">
                                <label>End Date</label>
                                <input type="date" class="form-input" @bind="exportEndDate" />
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(exportMessage))
                        {
                            <div class="alert @(exportSuccess ? "alert-success" : "alert-error")">
                                <span class="alert-icon">@(exportSuccess ? "✓" : "⚠")</span> @exportMessage
                            </div>
                        }

                        <div class="export-pdf-section">
                            <button class="export-btn-large" @onclick="ExportToPdf" disabled="@isExporting">
                                @if (isExporting)
                                {
                                    <span class="spinner-large"></span>
                                    <div class="export-info">
                                        <strong>Generating PDF...</strong>
                                        <small>Please wait while we create your document</small>
                                    </div>
                                }
                                else
                                {
                                    <span class="export-icon-large">📕</span>
                                    <div class="export-info">
                                        <strong>Export as PDF</strong>
                                        <small>Download your journal as a beautifully formatted PDF</small>
                                    </div>
                                }
                            </button>
                        </div>

                        <div class="export-tips">
                            <h6>Export Tips:</h6>
                            <ul>
                                <li>Select a date range to export specific entries</li>
                                <li>PDF includes all mood data, tags, and formatting</li>
                                <li>Large date ranges may take a moment to process</li>
                                <li>PDF will be saved to your device automatically</li>
                            </ul>
                        </div>
                    </div>
                }
            </div>

            <!-- Account Actions Section -->
            <div class="settings-accordion-item danger @(activeSection == "account" ? "active" : "")">
                <div class="accordion-header" @onclick='() => ToggleSection("account")'>
                    <div class="header-left">
                        <span class="accordion-icon">⚠️</span>
                        <span class="accordion-title">Account Actions</span>
                    </div>
                    <span class="accordion-arrow">@(activeSection == "account" ? "▼" : "▶")</span>
                </div>
                @if (activeSection == "account")
                {
                    <div class="accordion-content">
                        <div class="danger-zone">
                            <div class="danger-warning">
                                <span class="warning-icon">⚠️</span>
                                <strong>Danger Zone</strong>
                            </div>
                            <p class="section-description">Proceed with caution. These actions are permanent.</p>

                            <button class="btn-logout" @onclick="Logout">
                                <span class="btn-icon">🚪</span> Logout
                            </button>

                            <button class="btn-danger" @onclick="DeleteAccount" disabled="@isDeletingAccount">
                                @if (isDeletingAccount)
                                {
                                    <span class="spinner"></span>
                                }
                                else
                                {
                                    <span class="btn-icon">🗑️</span>
                                }
                                Delete Account
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</AuthGuard>

@code {
    // UI State
    private string activeSection = "profile";

    // Theme
    private bool isDarkMode = false;

    // Password Change
    private bool showPasswordForm = false;
    private string currentPassword = "";
    private string newPassword = "";
    private string confirmPassword = "";
    private string? passwordMessage = null;
    private bool passwordSuccess = false;

    // PIN System
    private bool hasPinSet = false;
    private bool showGeneratedPin = false;
    private bool isGeneratingPin = false;
    private string generatedPinCode = "";
    private string? pinMessage = null;

    // Export
    private DateTime exportStartDate = DateTime.Today.AddMonths(-1);
    private DateTime exportEndDate = DateTime.Today;
    private bool isExporting = false;
    private string? exportMessage = null;
    private bool exportSuccess = false;

    // Account
    private bool isDeletingAccount = false;

    protected override async Task OnInitializedAsync()
    {
        if (UserService.CurrentUser != null)
        {
            isDarkMode = UserService.CurrentUser.Theme == "Dark";
            hasPinSet = await AuthService.IsPinSetAsync();
        }
    }

    private string GetInitials()
    {
        if (UserService.CurrentUser?.FullName == null)
            return "??";

        var parts = UserService.CurrentUser.FullName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return parts[0].Substring(0, Math.Min(2, parts[0].Length)).ToUpper();
    }

    private void ToggleSection(string section)
    {
        activeSection = activeSection == section ? "" : section;
    }

    #region Theme

    private async Task ToggleDarkMode(ChangeEventArgs e)
    {
        isDarkMode = (bool)e.Value!;
        var newTheme = isDarkMode ? "Dark" : "Light";

        if (UserService.CurrentUser != null)
        {
            await UserService.UpdateUserThemeAsync(newTheme);
            await ThemeService.ToggleThemeAsync(UserService.CurrentUser.Id);
        }
    }

    #endregion

    #region Password Change

    private void ShowPasswordForm()
    {
        showPasswordForm = true;
        passwordMessage = null;
        currentPassword = "";
        newPassword = "";
        confirmPassword = "";
    }

    private void CancelPasswordForm()
    {
        showPasswordForm = false;
        passwordMessage = null;
    }

    private async Task ChangePassword()
    {
        passwordMessage = null;
        passwordSuccess = false;

        var result = await UserService.ChangePasswordAsync(currentPassword, newPassword, confirmPassword);

        if (result.Success)
        {
            passwordSuccess = true;
            passwordMessage = result.Message;
            await Task.Delay(2000);
            showPasswordForm = false;
        }
        else
        {
            passwordMessage = result.Message;
        }
    }

    #endregion

    #region PIN System

    private async Task GeneratePin()
    {
        isGeneratingPin = true;
        pinMessage = null;

        await Task.Delay(500);

        var random = new Random();
        generatedPinCode = random.Next(100000, 999999).ToString();

        await AuthService.SetPinAsync(generatedPinCode);

        hasPinSet = true;
        showGeneratedPin = true;
        isGeneratingPin = false;
        pinMessage = "PIN generated successfully! Please save it securely.";
    }

    private async Task ShowViewPinDialog()
    {
        // If PIN was just generated in this session, we can show it
        if (showGeneratedPin && !string.IsNullOrEmpty(generatedPinCode))
        {
            await JS.InvokeVoidAsync("alert",
                $"✅ Your Current PIN:\n\n{generatedPinCode}\n\n" +
                "Please save this PIN securely.");
            return;
        }

        // Otherwise, explain that PINs cannot be retrieved after generation
        var password = await JS.InvokeAsync<string>("prompt", "🔒 Enter your password:");

        if (!string.IsNullOrEmpty(password))
        {
            var result = await UserService.LoginAsync(UserService.CurrentUser!.Username, password);

            if (result.Success)
            {
                await JS.InvokeVoidAsync("alert",
                    "⚠️ Security Notice\n\n" +
                    "For security reasons, PINs are hashed and cannot be displayed after the initial generation session.\n\n" +
                    "This is intentional - it protects your security by ensuring PINs cannot be recovered if someone gains access to the database.\n\n" +
                    "If you've forgotten your PIN:\n" +
                    "1. Click 'Delete PIN'\n" +
                    "2. Click 'Generate PIN' to create a new one\n" +
                    "3. Save the new PIN securely");
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "❌ Incorrect password");
            }
        }
    }

    private async Task ShowDeletePinDialog()
    {
        var password = await JS.InvokeAsync<string>("prompt", "🔒 Enter your password to delete PIN:");

        if (!string.IsNullOrEmpty(password))
        {
            var result = await UserService.LoginAsync(UserService.CurrentUser!.Username, password);

            if (result.Success)
            {
                var confirmed = await JS.InvokeAsync<bool>("confirm",
                    "⚠️ Are you sure you want to delete your PIN?\n\nYou will need to generate a new one to use quick login.");

                if (confirmed)
                {
                    await DeletePin();
                }
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "❌ Incorrect password");
            }
        }
    }

    private async Task ShowRegeneratePinDialog()
    {
        var password = await JS.InvokeAsync<string>("prompt", "🔒 Enter your password to regenerate PIN:");

        if (!string.IsNullOrEmpty(password))
        {
            var result = await UserService.LoginAsync(UserService.CurrentUser!.Username, password);

            if (result.Success)
            {
                var confirmed = await JS.InvokeAsync<bool>("confirm",
                    "🔄 Regenerate PIN?\n\nThe old PIN will be deleted and a new one will be generated.");

                if (confirmed)
                {
                    await DeletePin();
                    await GeneratePin();
                }
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "❌ Incorrect password");
            }
        }
    }

    private async Task DeletePin()
    {
        await AuthService.RemovePinAsync("");
        hasPinSet = false;
        showGeneratedPin = false;
        generatedPinCode = "";
        pinMessage = "PIN deleted successfully.";
    }

    private async Task CopyPinToClipboard()
    {
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", generatedPinCode);
        pinMessage = "✓ PIN copied to clipboard!";
        StateHasChanged();
    }

    #endregion

    #region Export

    private async Task ExportToPdf()
    {
        try
        {
            isExporting = true;
            exportMessage = null;
            exportSuccess = false;
            StateHasChanged();

            var filePath = await ExportService.ExportToPdfAsync(exportStartDate, exportEndDate);

            exportMessage = $"PDF exported successfully! Saved as: {Path.GetFileName(filePath)}";
            exportSuccess = true;

            // Open or share the PDF
            await ExportService.OpenPdfAsync(filePath);
        }
        catch (Exception ex)
        {
            exportMessage = $"Export failed: {ex.Message}";
            exportSuccess = false;
        }
        finally
        {
            isExporting = false;
        }
    }

    #endregion

    #region Account Actions

    private void Logout()
    {
        UserService.Logout();
        Navigation.NavigateTo("/login", forceLoad: true);
    }

    private async Task DeleteAccount()
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm",
            "⚠️ WARNING: This will permanently delete your account and all journal entries. This action cannot be undone. Are you absolutely sure?");

        if (confirmed)
        {
            var doubleConfirm = await JS.InvokeAsync<bool>("confirm",
                "This is your last chance. Click OK to proceed with account deletion.");

            if (doubleConfirm)
            {
                var verification = await JS.InvokeAsync<string>("prompt",
                    "Type DELETE (in capital letters) to confirm:");

                if (verification == "DELETE")
                {
                    isDeletingAccount = true;
                    try
                    {
                        var success = await UserService.DeleteAccountAsync();
                        if (success)
                        {
                            await JS.InvokeVoidAsync("alert", "Account deleted successfully.");
                            Logout();
                        }
                        else
                        {
                            await JS.InvokeVoidAsync("alert", "Failed to delete account. Please try again.");
                        }
                    }
                    catch (Exception ex)
                    {
                        await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
                    }
                    finally
                    {
                        isDeletingAccount = false;
                    }
                }
            }
        }
    }

    #endregion
}
