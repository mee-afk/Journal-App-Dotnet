@page "/login"

@inject UserService UserService
@inject NavigationManager Navigation
@using System.Text.Json
@layout EmptyLayout

<div class="auth-container">
    <div class="auth-card">
        <div class="auth-header">
            <h3>
                <span class="oi oi-book me-2"></span>
                Welcome to My Journal
            </h3>
            <p class="text-muted">Sign in to continue</p>
        </div>

        <!-- Tab Navigation -->
        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "password" ? "active" : "")"
                        @onclick='() => activeTab = "password"'>
                    <span class="oi oi-lock-locked me-2"></span>
                    Password
                </button>
            </li>

            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "pin" ? "active" : "")"
                        @onclick='() => activeTab = "pin"'>
                    <span class="oi oi-key me-2"></span>
                    Quick PIN
                </button>
            </li>
        </ul>

        <!-- Password Login Form -->
        @if (activeTab == "password")
        {
            <div class="login-form">
                <div class="mb-3">
                    <label for="username" class="form-label">Username</label>
                    <input type="text"
                           class="form-control"
                           id="username"
                           @bind="username"
                           placeholder="Enter your username"
                           @onkeyup="HandlePasswordEnter" />
                </div>

                <div class="mb-3">
                    <label for="password" class="form-label">Password</label>
                    <input type="password"
                           class="form-control"
                           id="password"
                           @bind="password"
                           placeholder="Enter your password"
                           @onkeyup="HandlePasswordEnter" />
                </div>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger">
                        <span class="oi oi-warning me-2"></span>
                        @errorMessage
                    </div>
                }

                <button class="btn btn-primary w-100 mb-3"
                        @onclick="LoginWithPassword"
                        disabled="@isLoggingIn">
                    @if (isLoggingIn)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    Sign In
                </button>

                <div class="text-center">
                    <a href="/register" class="text-decoration-none">
                        Don't have an account? <strong>Register</strong>
                    </a>
                </div>
            </div>
        }

        <!-- PIN Login Form -->
        @if (activeTab == "pin")
        {
            <div class="login-form">
                <div class="mb-3">
                    <label for="pin" class="form-label">Quick PIN</label>
                    <input type="password"
                           class="form-control form-control-lg text-center"
                           id="pin"
                           @bind="pin"
                           placeholder="Enter PIN"
                           maxlength="6"
                           style="letter-spacing: 1rem; font-size: 2rem;"
                           @onkeyup="HandlePinEnter" />
                    <small class="text-muted">Enter your 4–6 digit PIN</small>
                </div>

                @if (!string.IsNullOrEmpty(pinErrorMessage))
                {
                    <div class="alert alert-danger">
                        <span class="oi oi-warning me-2"></span>
                        @pinErrorMessage
                    </div>
                }

                <button class="btn btn-primary w-100 mb-3"
                        @onclick="LoginWithPin"
                        disabled="@isPinLoggingIn">
                    @if (isPinLoggingIn)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    Login with PIN
                </button>

                <div class="text-center">
                    <button class="btn btn-link"
                            @onclick='() => activeTab = "password"'>
                        Use password instead
                    </button>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private string activeTab = "password";

    // Password login
    private string username = "";
    private string password = "";
    private string errorMessage = "";
    private bool isLoggingIn = false;

    // PIN login
    private string pin = "";
    private string pinErrorMessage = "";
    private bool isPinLoggingIn = false;

    protected override async Task OnInitializedAsync()
    {
        // If already logged in, redirect to home
        if (UserService.IsLoggedIn)
        {
            Navigation.NavigateTo("/");
        }
    }

    #region Password Login

    private async Task LoginWithPassword()
    {
        try
        {
            isLoggingIn = true;
            errorMessage = "";

            var result = await UserService.LoginAsync(username, password);

            if (result.Success)
            {
                Navigation.NavigateTo("/");
            }
            else
            {
                errorMessage = result.Message;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Login failed: {ex.Message}";
        }
        finally
        {
            isLoggingIn = false;
        }
    }

    private async Task HandlePasswordEnter(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !isLoggingIn)
        {
            await LoginWithPassword();
        }
    }

    #endregion

    #region PIN Login

    private async Task LoginWithPin()
    {
        try
        {
            isPinLoggingIn = true;
            pinErrorMessage = "";

            if (string.IsNullOrWhiteSpace(pin))
            {
                pinErrorMessage = "Please enter your PIN";
                return;
            }

            if (pin.Length < 4 || pin.Length > 6)
            {
                pinErrorMessage = "PIN must be 4–6 digits";
                return;
            }

            if (!pin.All(char.IsDigit))
            {
                pinErrorMessage = "PIN must contain only numbers";
                return;
            }

            var result = await UserService.LoginWithPinAsync(pin);

            if (result.Success)
            {
                if (result.Users != null && result.Users.Count > 1)
                {
                    var usersJson = JsonSerializer.Serialize(result.Users);
                    var encodedJson = JsonSerializer.Serialize(usersJson);

                    Navigation.NavigateTo(
                        $"/pin-select?UsersJson={Uri.EscapeDataString(encodedJson)}");
                }
                else
                {
                    Navigation.NavigateTo("/");
                }
            }
            else
            {
                pinErrorMessage = result.Message;
            }
        }
        catch (Exception ex)
        {
            pinErrorMessage = $"PIN login failed: {ex.Message}";
        }
        finally
        {
            isPinLoggingIn = false;
        }
    }

    private async Task HandlePinEnter(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !isPinLoggingIn)
        {
            await LoginWithPin();
        }
    }

    #endregion
}

<style>
    .auth-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
    }

    .auth-card {
        background: var(--bg-primary);
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        padding: 2rem;
        width: 100%;
        max-width: 450px;
    }

    .auth-header {
        text-align: center;
        margin-bottom: 2rem;
    }

        .auth-header h3 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

    .nav-tabs {
        border-bottom: 2px solid var(--border-color);
    }

        .nav-tabs .nav-link {
            color: var(--text-secondary);
            border: none;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
        }

            .nav-tabs .nav-link.active {
                color: var(--accent-color);
                background: transparent;
                border-bottom: 2px solid var(--accent-color);
            }

            .nav-tabs .nav-link:hover {
                border: none;
                color: var(--accent-color);
            }

    .login-form {
        margin-top: 1.5rem;
    }

    .form-label {
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .form-control {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 0.75rem;
    }

        .form-control:focus {
            background: var(--bg-secondary);
            border-color: var(--accent-color);
            color: var(--text-primary);
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 0.75rem;
        font-weight: 600;
        transition: transform 0.2s;
    }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            transform: none;
            opacity: 0.6;
        }

    @@media (max-width: 576px) {
        .auth-card

    {
        padding: 1.5rem;
    }

    }
</style>
